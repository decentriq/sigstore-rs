/*
 * Rekor
 *
 * Rekor is a cryptographically secure, immutable transparency log for signed software releases.
 *
 * The version of the OpenAPI document: 0.0.1
 *
 * Generated by: https://openapi-generator.tech
 */

use crate::crypto::merkle::hex_to_hash_output;
use crate::crypto::CosignVerificationKey;
use crate::errors::SigstoreError;
use crate::rekor::models::checkpoint::SignedCheckpoint;
use crate::rekor::models::ConsistencyProof;
use crate::rekor::TreeSize;
use serde::{Deserialize, Serialize};

#[derive(Clone, Debug, PartialEq, Eq, Serialize, Deserialize)]
pub struct LogInfo {
    /// The current hash value stored at the root of the merkle tree
    #[serde(rename = "rootHash")]
    pub root_hash: String,
    /// The current number of nodes in the merkle tree
    #[serde(rename = "treeSize")]
    pub tree_size: TreeSize,
    /// The current signed tree head
    #[serde(rename = "signedTreeHead")]
    pub signed_tree_head: SignedCheckpoint,
    /// The current treeID
    #[serde(rename = "treeID")]
    pub tree_id: Option<String>,
    #[serde(rename = "inactiveShards", skip_serializing_if = "Option::is_none")]
    pub inactive_shards: Option<Vec<crate::rekor::models::InactiveShardLogInfo>>,
}

impl LogInfo {
    pub fn new(
        root_hash: String,
        tree_size: TreeSize,
        signed_tree_head: SignedCheckpoint,
    ) -> LogInfo {
        LogInfo {
            root_hash,
            tree_size,
            signed_tree_head,
            tree_id: None,
            inactive_shards: None,
        }
    }

    pub fn verify_consistency(
        &self,
        old_size: usize,
        old_root: &str,
        consistency_proof: &ConsistencyProof,
        rekor_key: &CosignVerificationKey,
    ) -> Result<(), SigstoreError> {
        // verify checkpoint is signed by log
        self.signed_tree_head.verify_signature(rekor_key)?;

        self.signed_tree_head.valid_consistency_proof(
            &hex_to_hash_output(&self.root_hash)?,
            self.tree_size as u64,
        )?;
        consistency_proof.verify(old_size, old_root, self.tree_size as _)?;
        Ok(())
    }
}
